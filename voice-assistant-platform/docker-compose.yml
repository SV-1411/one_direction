version: '3.9'
services:
  mongodb:
    image: mongo:7
    ports: ['27017:27017']
    volumes: [mongo_data:/data/db]
  ollama:
    image: ollama/ollama:latest
    ports: ['11434:11434']
    volumes: [ollama_data:/root/.ollama]
    entrypoint: ["/bin/sh","-c","ollama serve & sleep 5 && ollama pull ${OLLAMA_MODEL:-llama3} && wait"]
  backend:
    build: ./backend
    env_file: .env
    depends_on: [mongodb, ollama]
    ports: ['8000:8000']
    volumes:
      - ./audio_storage:/app/audio_storage
  frontend:
    image: node:20-alpine
    working_dir: /app
    env_file: .env
    volumes:
      - ./frontend:/app
    command: sh -c "npm install && npm run dev"
    depends_on: [backend]
    ports: ['3000:3000']
volumes:
  mongo_data:
  ollama_data:
